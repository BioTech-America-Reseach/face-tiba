<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zodiac Bio-Scanner ¬∑ Kituo cha Afya</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(145deg, #0a1928 0%, #1a3344 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
        }

        .app-container {
            max-width: 480px;
            width: 100%;
            background: rgba(10, 25, 40, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 255, 255, 0.25);
            border-radius: 48px;
            padding: 24px;
            box-shadow: 0 30px 60px rgba(0, 20, 30, 0.8), 0 0 0 2px rgba(0, 255, 255, 0.1) inset;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 28px;
            position: relative;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #a0f0ff, #70ffd0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 1px;
        }

        .device-id {
            font-size: 0.75rem;
            color: #4a9ea0;
            background: rgba(0, 255, 255, 0.1);
            padding: 6px 16px;
            border-radius: 40px;
            display: inline-block;
            margin-top: 8px;
            border: 1px solid #2f6f7a;
            font-family: monospace;
        }

        /* Admin Login Toggle */
        .admin-section {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 16px;
        }
        .admin-btn {
            background: transparent;
            border: 1px solid #00f2ff;
            color: #00f2ff;
            padding: 8px 16px;
            border-radius: 40px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: 0.2s;
        }
        .admin-btn:hover {
            background: #00f2ff20;
        }
        .admin-panel {
            background: #102530;
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid #00f2ff;
        }
        .admin-panel input {
            background: #1f3a48;
            border: 1px solid #00f2ff;
            color: white;
            padding: 12px;
            border-radius: 40px;
            width: 100%;
            margin-bottom: 10px;
        }
        .flex-row {
            display: flex;
            gap: 10px;
        }

        /* Card Style */
        .card {
            background: rgba(20, 40, 55, 0.7);
            border-radius: 32px;
            padding: 24px;
            border: 1px solid #2e5f6b;
            box-shadow: 0 15px 30px -10px black;
            margin-bottom: 20px;
            transition: 0.3s;
        }

        .hidden {
            display: none !important;
        }

        /* Inputs */
        input {
            width: 100%;
            padding: 16px 20px;
            background: #0f212e;
            border: 2px solid #2b5e6b;
            border-radius: 60px;
            font-size: 1rem;
            color: white;
            outline: none;
            transition: 0.2s;
            margin-bottom: 16px;
        }

        input:focus {
            border-color: #00f2ff;
            box-shadow: 0 0 15px #00f2ff80;
        }

        input::placeholder {
            color: #80b8c0;
        }

        /* Button */
        .btn {
            background: linear-gradient(145deg, #00e0ff, #0099cc);
            border: none;
            padding: 16px 24px;
            border-radius: 60px;
            font-weight: 700;
            font-size: 1.1rem;
            color: #0a1928;
            width: 100%;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid #80ffff;
            box-shadow: 0 8px 0 #006080, 0 10px 20px black;
        }

        .btn:active {
            transform: translateY(5px);
            box-shadow: 0 3px 0 #006080, 0 10px 20px black;
        }

        .btn.secondary {
            background: transparent;
            color: #00f2ff;
            border: 2px solid #00f2ff;
            box-shadow: none;
        }

        .btn.secondary:active {
            transform: translateY(2px);
        }

        .btn.small {
            padding: 10px 16px;
            font-size: 0.9rem;
        }

        /* Profile Lock */
        .profile-card {
            background: linear-gradient(145deg, #0b2c3b, #05222e);
            border-radius: 28px;
            padding: 20px;
            border: 2px solid #00f2ff;
            position: relative;
            overflow: hidden;
        }

        .profile-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, #00f2ff20, transparent 70%);
            animation: rotate 10s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .profile-name {
            font-size: 1.8rem;
            font-weight: 700;
            color: #00f2ff;
            text-shadow: 0 0 10px cyan;
            position: relative;
        }

        .profile-year {
            color: #b0f0ff;
            margin-bottom: 20px;
            position: relative;
        }

        /* Camera Wrapper */
        .camera-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 40px;
            overflow: hidden;
            border: 3px solid #00f2ff;
            box-shadow: 0 0 30px #00f2ff;
            margin: 20px 0;
            background: black;
        }

        video, canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .laser-line {
            position: absolute;
            width: 100%;
            height: 4px;
            background: #00f2ff;
            box-shadow: 0 0 30px cyan, 0 0 60px blue;
            top: 0;
            left: 0;
            z-index: 20;
            animation: scanMove 2s infinite ease-in-out;
        }

        @keyframes scanMove {
            0% { top: 0; }
            50% { top: calc(100% - 4px); }
            100% { top: 0; }
        }

        .scan-status {
            text-align: center;
            color: #00f2ff;
            font-weight: 600;
            margin: 10px 0;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Results */
        .results-card {
            background: white;
            border-radius: 32px;
            padding: 24px;
            color: #0a1928;
        }

        .zodiac-badge {
            background: #00c8ff;
            color: #021016;
            padding: 12px 24px;
            border-radius: 60px;
            font-weight: 800;
            font-size: 1.6rem;
            display: inline-block;
            margin: 10px 0;
        }

        .risk-title {
            color: #d32f2f;
            font-weight: 800;
            font-size: 1.2rem;
            margin-top: 20px;
            border-left: 8px solid #d32f2f;
            padding-left: 12px;
        }

        .risk-list {
            list-style: none;
            margin: 10px 0;
        }

        .risk-list li {
            background: #ffeaea;
            padding: 12px 18px;
            border-radius: 20px;
            margin-bottom: 8px;
            border-left: 5px solid #f44336;
            font-weight: 500;
        }

        .medicine-box {
            background: #e0f7fa;
            border-radius: 20px;
            padding: 16px;
            margin: 16px 0;
            border-left: 8px solid #0077be;
        }

        .medicine-box h4 {
            color: #01579b;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .food-tip {
            background: #1b5e20;
            color: white;
            padding: 18px;
            border-radius: 24px;
            margin: 20px 0;
            font-size: 1.1rem;
            text-align: center;
            border: 2px solid #a5d6a7;
        }

        .download-btn {
            background: #2e7d32;
            border: none;
            color: white;
            padding: 14px;
            border-radius: 60px;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
            cursor: pointer;
            border: 1px solid #a5d6a7;
        }

        .admin-badge {
            background: #ffb74d;
            color: #1a1a1a;
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 10px;
        }

        .disclaimer {
            font-size: 0.7rem;
            color: #6b8e9c;
            text-align: center;
            margin-top: 16px;
        }
    </style>
</head>
<body>
<div class="app-container" id="app">
    
    <!-- Header -->
    <div class="header">
        <h1>‚öïÔ∏èZODIAC BIO-SCAN</h1>
        <div class="device-id" id="deviceId">üî¨ DEVICE: LOADING...</div>
    </div>

    <!-- Admin Toggle (small button) -->
    <div class="admin-section">
        <span class="admin-btn" id="adminToggleBtn">üë§ ADMIN</span>
    </div>

    <!-- Admin Login Panel (hidden by default) -->
    <div id="adminPanel" class="admin-panel hidden">
        <input type="password" id="adminCode" placeholder="üîê Weka code ya siri">
        <div class="flex-row">
            <button class="btn small" id="adminLoginBtn">INGIA KAMA ADMIN</button>
            <button class="btn secondary small" id="adminLogoutBtn">TOKA</button>
        </div>
        <p id="adminStatus" style="color:#ffb74d; font-size:0.8rem; margin-top:8px;"></p>
    </div>

    <!-- USajili (Registration) -->
    <div id="registrationSection" class="card">
        <h3 style="color:#a0f0ff; margin-bottom: 16px;">üìã SAJILI KIFAA</h3>
        <p style="color:#b0d0d0; margin-bottom: 16px;">Ingiza taarifa zako ili kukifunga kifaa kwako.</p>
        <input type="text" id="regName" placeholder="Jina lako kamili" autocomplete="off">
        <input type="number" id="regYear" placeholder="Mwaka wa kuzaliwa (mfano: 1995)" min="1900" max="2100">
        <button class="btn" id="registerBtn">üîí SAJILI NA FUNGA KIFAA</button>
    </div>

    <!-- Profile Locked (Baada ya kusajili) -->
    <div id="profileSection" class="profile-card hidden">
        <div style="position: relative; z-index: 2;">
            <div style="font-size: 0.9rem; color: #80e0ff;">üÜî KITAMBULISHO KIMEFUNGWA</div>
            <div class="profile-name" id="profileName">-</div>
            <div class="profile-year" id="profileYear">-</div>
            <!-- Admin badge itaonekana kama ni admin -->
            <div id="adminBadge" class="admin-badge hidden">üëë ADMIN MODE</div>
            <!-- Kitufe cha Scan kitaonekana kulingana na ruhusa -->
            <button class="btn" id="startScanBtn">üì∏ ANZA SCAN YA USO</button>
            <button class="btn secondary" id="resetBtn" style="margin-top: 10px;">üîÑ BADILISHA MTUMIAJI</button>
            <!-- Onyo kwa user aliyeisha scan -->
            <p id="scanLimitMsg" style="color: #ffaa66; margin-top: 12px; font-size:0.9rem; display: none;">‚úîÔ∏è Umepiga scan moja. Ikiwa unahitaji nyingine, ingia kama admin.</p>
        </div>
    </div>

    <!-- Camera + Scan -->
    <div id="cameraSection" class="hidden">
        <div class="camera-container" id="cameraContainer">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" style="display: none;"></canvas>
            <div id="laserLine" class="laser-line" style="display: none;"></div>
        </div>
        <div id="scanStatus" class="scan-status"></div>
        <button class="btn" id="captureBtn">üì∑ PIGA SELFI</button>
        <button class="btn secondary" id="cancelCameraBtn" style="margin-top: 10px;">‚úñÔ∏è GHARI</button>
    </div>

    <!-- Matokeo (Results) -->
    <div id="resultsSection" class="hidden">
        <div class="results-card">
            <div style="text-align: center;">
                <div style="font-size: 1rem; color: #0288d1;">RIPOTI YA ZODIAC</div>
                <div class="zodiac-badge" id="resultZodiac">-</div>
            </div>

            <div class="risk-title">üö® MAGONJWA YANAYOWEZA KUKUFIKIA</div>
            <ul class="risk-list" id="diseaseList"></ul>

            <div class="medicine-box">
                <h4>üåø DAWA ZA KICHINA (HERBAL)</h4>
                <p id="chinaMeds"></p>
            </div>

            <div class="medicine-box">
                <h4>üíä DR. WILLIAM CLINIC</h4>
                <p id="williamMeds"></p>
            </div>

            <div class="medicine-box">
                <h4>üå± TIBA YA NYUMBANI (MIMEA)</h4>
                <p id="herbMeds"></p>
            </div>

            <div class="food-tip" id="foodTip"></div>

            <!-- Download Report Button -->
            <button class="download-btn" id="downloadReportBtn">üì• PAKUA RIPOTI (TXT)</button>

            <!-- Vitufe vya urambazaji -->
            <button class="btn secondary" id="newScanBtn" style="margin-top: 16px;">üîÑ FANYA SCAN MPYA</button>
            <button class="btn secondary" id="homeBtn" style="margin-top: 10px;">üè† NYUMBANI</button>
        </div>
    </div>

    <div class="disclaimer">
        ‚öïÔ∏è Matokeo ni kwa ajili ya burudani tu. Kwa dalili zozote, wasiliana na daktari.
    </div>
</div>

<script>
    (function() {
        // ---------- Database ya Zodiac ----------
        humvconst zodiacData = {
          const zodiacData = {
    "Panya": {
        diseases: [
            "Shinikizo la damu", 
            "Maumivu ya kichwa", 
            "Kukosa usingizi", 
            "Mzio", 
            "Uchovu wa macho",
            "Kizunguzungu",
            "Kupoteza kumbukumbu",
            "Wasiwasi"
        ],
        chinaMeds: "Ginseng + Shan Zha (kuchukwa asubuhi na jioni)",
        chinaMedsDetails: "Ginseng huongeza nishati na kinga, Shan Zha husaidia mzunguko wa damu. Kuchukwa kwa wiki 2 kisha pumzika wiki 1. Kipimo: vidonge 2 asubuhi na 2 jioni baada ya chakula.",
        williamMeds: "William's Calm Tabs (vidonge 2 kwa siku)",
        williamMedsDetails: "Dawa ya asili yenye valerian na chamomile kwa utulivu na usingizi mzuri. Kipimo: kidonge 1 asubuhi na 1 jioni. Inasaidia kupunguza msongo wa mawazo na shinikizo.",
        herbMeds: "Tangawizi na asali ya mwitu",
        herbMedsDetails: "Changanya kijiko 1 cha tangawizi safi iliyokunwa na kijiko 1 cha asali ya mwitu kwenye maji ya joto. Kunywa asubuhi na macho. Husaidia kuyeyusha damu na kupunguza mzio.",
        food: "üçö Wali kahawia, mboga za majani, samaki",
        foodDetails: "Wali kahawia una magnesiamu na nyuzinyuzi. Mboga za majani (spinachi, kabichi) hupunguza shinikizo. Samaki kama dagaa wana omega-3 kwa afya ya moyo. Epuka vyakula vya kukaanga na chumvi nyingi.",
        additionalTips: [
            "Tembea kwa miguu dakika 30 kila siku ili kupunguza shinikizo.",
            "Epuka kukaa muda mrefu kwenye simu au kompyuta ‚Äì pumzisha macho kila dakika 20.",
            "Usingizi wa kutosha (masaa 7-8) ni muhimu; epuka kahawa jioni.",
            "Mazoezi ya kupumua (pranayama) husaidia kutuliza mfumo wa neva.",
            "Kula tufaha na ndizi mara kwa mara kwa potasiamu."
        ],
        precautions: [
            "Usichukue Ginseng ikiwa una shinikizo la damu lisilodhibitiwa au una damu kutokwa kwa urahisi.",
            "William's Calm Tabs inaweza kusinzia ‚Äì usiendeshe gari baada ya kumeza.",
            "Tangawizi inaweza kuwasha tumbo ikiwa unakula kwenye njaa."
        ]
    },
    "Ng'ombe": {
        diseases: [
            "Maumivu ya viungo",
            "Uchovu sugu",
            "Kuvimba tumbo",
            "Sukari",
            "Mafua",
            "Maumivu ya mgongo",
            "Ngozi kukauka",
            "Kupoteza uzito"
        ],
        chinaMeds: "Du Zhong + Gou Qi Zi (kwa nguvu za mwili)",
        chinaMedsDetails: "Du Zhong huimarisha mifupa na viungo; Gou Qi Zi hulisha damu na macho. Kipimo: vidonge 3 kwa siku (asubuhi, mchana, jioni) kwa wiki 3. Inasaidia pia kupunguza sukari.",
        williamMeds: "Joint-Force Pro (kijiko 1 kwa siku)",
        williamMedsDetails: "Dawa ya mimea yenye glucosamine, chondroitin, na boswellia kwa viungo. Kijiko 1 (5ml) asubuhi kwenye maji. Inapunguza uvimbe na kuboresha mwendo.",
        herbMeds: "Maji ya mwarobaini na kitunguu saumu",
        herbMedsDetails: "Chemsha majani ya mwarobaini kwa dakika 10, ongeza kitunguu saumu kipande kimoja kilichosagwa. Kunywa kikombe 1 asubuhi na jioni. Husaidia kuua vimelea na kupunguza maumivu.",
        food: "ü•© Nyama konda, viazi vitamin, mboga za kijani",
        foodDetails: "Nyama konda (kuku, sungura) ina protini bila mafuta mengi. Viazi vitamin vina vitamini A na potasiamu. Mboga za kijani (broccoli, sukumawiki) hupunguza sukari na kuvimba. Epuka sukari na unga mweupe.",
        additionalTips: [
            "Fanya mazoezi ya kuogelea au kutembea ili kupunguza mzigo kwenye viungo.",
            "Paka mafuta ya mwarobaini kwenye viungo vinavyoumiza.",
            "Kunywa maji ya kutosha (lita 2 kwa siku) kusaidia kuyeyusha sumu.",
            "Kaa kwenye jua asubuhi kwa dakika 15 kupata vitamini D.",
            "Epuka kukaa kwa muda mrefu katika hali moja ‚Äì badilisha mkao."
        ],
        precautions: [
            "Du Zhong inaweza kupunguza shinikizo la damu ‚Äì fuatilia shinikizo ukiitumia.",
            "Kitunguu saumu kinaweza kuingiliana na dawa za kuzuia kuganda kwa damu.",
            "Joint-Force Pro isitumike kwa watoto au wajawazito bila ushauri wa daktari."
        ]
    },
    "Simba": {
        diseases: [
            "Mkazo wa moyo",
            "Wasiwasi",
            "Kukosa hamu ya kula",
            "Maumivu ya mgongo",
            "Kikohozi",
            "Kikosi cha joto mwilini",
            "Kikohozi cha mzio",
            "Mkazo wa akili"
        ],
        chinaMeds: "Xiao Yao San (kwa utulivu)",
        chinaMedsDetails: "Dawa ya asili ya Kichina inayotengeneza usawa wa ini na wengu. Kuchukwa pakiti 1 asubuhi na jioni kwa wiki 2. Husaidia kupunguza wasiwasi, kuboresha hamu ya kula, na kutuliza moyo.",
        williamMeds: "Cardio Health Complex + Omega-3",
        williamMedsDetails: "Virutubisho vya coenzyme Q10, magnesiamu, na omega-3 kwa afya ya moyo. Kipimo: vidonge 2 asubuhi na 2 jioni. Inasaidia kupunguza mkazo wa moyo na cholesterol.",
        herbMeds: "Chai ya mchaichai na ndimu",
        herbMedsDetails: "Mchaichai (moringa) hulisha virutubisho, ndimu ina vitamini C. Chemsha majani ya mchaichai, ongeza maji ya ndimu. Kunywa vikombe 2 kwa siku. Husaidia kusafisha damu na kupunguza kikohozi.",
        food: "ü•ë Parachichi, samaki, mafuta ya zeituni",
        foodDetails: "Parachichi lina mafuta bora kwa moyo. Samaki (jodari, mkisi) wana omega-3. Mafuta ya zeituni hupunguza cholesterol mbaya. Epuka nyama nyekundu na vyakula vya kukaanga.",
        additionalTips: [
            "Tafuta shughuli za kupumzika kama yoga, kutafakari, au kusikiliza muziki.",
            "Epuka msongo kwa kupanga muda wako vizuri.",
            "Kula tunda la passion au machungwa kwa vitamini C na kutuliza.",
            "Tembea kwenye mazingira ya asili (bustani, msitu) ili kupunguza msongo.",
            "Pata usingizi wa kutosha na epuka kukaa usiku sana."
        ],
        precautions: [
            "Omega-3 inaweza kuongeza damu kutoka kwa urahisi ‚Äì waambie daktari kabla ya upasuaji.",
            "Xiao Yao San isitumike ikiwa una homa kali au maambukizi ya bakteria.",
            "Mchaichai inaweza kuwa laxative ikiwa inatumiwa kwa wingi ‚Äì shika kipimo."
        ]
    },
    "Sungura": {
        diseases: [
            "Ngozi kuwasha",
            "Mzio wa msimu",
            "Kikohozi kavu",
            "Kukosa usingizi",
            "Maumivu ya kichwa",
            "Upele wa ngozi",
            "Macho kuwasha",
            "Kupiga chafya"
        ],
        chinaMeds: "Yu Ping Feng (kwa kinga ya mwili)",
        chinaMedsDetails: "Dawa ya Kichina inayoimarisha mfumo wa kinga na kuzuia mzio. Kuchukwa vidonge 2 asubuhi na jioni kwa mwezi mmoja. Inasaidia kupunguza mizio na kikohozi cha msimu.",
        williamMeds: "Allergy Relief Spray",
        williamMedsDetails: "Dawa ya kunyunyizia puani yenye mimea (nettle, eucalyptus). Nyunyizia pua mara 2 kwa siku wakati wa mzio. Husaidia kupunguza kuwasha na kuziba kwa pua.",
        herbMeds: "Shada manii na mafuta ya nazi",
        herbMedsDetails: "Saga majani ya shada manii (occimum), changanya na mafuta ya nazi. Paka kwenye ngozi inayowasha au upele. Inatuliza haraka na kuua vimelea.",
        food: "ü•ï Karoti, spinachi, matunda ya machungwa",
        foodDetails: "Karoti zina beta-carotene kwa afya ya ngozi. Spinachi ina antioxidants. Matunda ya machungwa (machungwa, ndimu) yana vitamini C kupunguza mzio. Epuka vyakula vya kusindika na sukari.",
        additionalTips: [
            "Osha ngozi kwa maji baridi na sabuni laini kila baada ya kukaa nje.",
            "Weka unyevu ndani ya nyumba ili kupunguza mzio wa vumbi.",
            "Epuka maua na mimea inayotoa chavua wakati wa msimu wa mzio.",
            "Kunywa maji mengi kusaidia kuyeyusha histamine.",
            "Vaa nguo za pamba na epuka nguo za sintetiki zinazowasha."
        ],
        precautions: [
            "Yu Ping Feng inaweza kusababisha usingizi kwa wachache ‚Äì chukua jioni.",
            "Usitumie Allergy Relief Spray kwa zaidi ya siku 7 mfululizo bila daktari.",
            "Mafuta ya nazi yanaweza kuziba vinyweleo ‚Äì jaribu kwenye sehemu ndogo kwanza."
        ]
    },
    "Joka": {
        diseases: [
            "Msongo wa mawazo",
            "Koo kuvimba",
            "Homa",
            "Tumbo la chungu",
            "Maumivu ya viungo",
            "Maambukizi ya mafua",
            "Kikohozi cha homa",
            "Uchovu wa mwili"
        ],
        chinaMeds: "Ban Lan Gen + Yin Qiao",
        chinaMedsDetails: "Ban Lan Gen (radix isatidis) hupunguza homa na koo; Yin Qiao (lonicera + forsythia) hutibu mafua. Kuchukwa pakiti 1 kila baada ya masaa 6 wakati wa homa. Inasaidia kupunguza dalili haraka.",
        williamMeds: "Immuno Boost (vidonge 3 kwa siku)",
        williamMedsDetails: "Dawa ya asili yenye echinacea, zinc, na vitamini C. Kipimo: kidonge 1 asubuhi, mchana, jioni. Huongeza kinga na kufupisha muda wa homa.",
        herbMeds: "Chai ya tangawizi na asali",
        herbMedsDetails: "Chemsha vipande vya tangawizi safi kwa dakika 10, ongeza asali na maji ya ndimu. Kunywa vikombe 3-4 kwa siku. Husaidia kupunguza koo, homa, na kikohozi.",
        food: "üç≤ Supu ya mboga, nyama ya kuku, ndizi",
        foodDetails: "Supu ya mboga (vitunguu, karoti, viazi) hulisha na kupunguza homa. Nyama ya kuku ina protini nyepesi. Ndizi zina potasiamu na nishati. Epuka vyakula vya baridi na vya mafuta.",
        additionalTips: [
            "Pumzika kitandani mpaka homa ipungue.",
            "Weka unyevu hewani kwa kutumia humidifier au weka bakuli la maji karibu.",
            "Osha mikono mara kwa mara ili kuepuka kueneza maambukizi.",
            "Chukua maji ya joto na asali kabla ya kulala kutuliza koo.",
            "Epuka kuvuta sigara au kukaa karibu na moshi."
        ],
        precautions: [
            "Ban Lan Gen inaweza kusababisha kuhara kwa watu wenye tumbo nyeti.",
            "Immuno Boost isitumike kwa zaidi ya wiki 2 mfululizo.",
            "Tangawizi inaweza kuongeza asidi ya tumbo ‚Äì epuka ikiwa una kidonda cha tumbo."
        ]
    },
    "Nyoka": {
        diseases: [
            "Tumbo la chungu",
            "Kichefuchefu",
            "Wasiwasi mwingi",
            "Shinikizo",
            "Kukosa usingizi",
            "Kuhara",
            "Kuvimba tumbo",
            "Mkazo wa akili"
        ],
        chinaMeds: "Chen Pi + Bai Zhu (kwa tumbo)",
        chinaMedsDetails: "Chen Pi (ganda la chungwa) hupunguza gesi na kichefuchefu; Bai Zhu huimarisha utumbo. Kuchukwa vidonge 2 asubuhi na jioni baada ya chakula. Inasaidia kupunguza tumbo la chungu na wasiwasi.",
        williamMeds: "Gastro Comfort + Magnesium",
        williamMedsDetails: "Dawa ya mimea yenye peppermint, ginger, na probiotics kwa afya ya utumbo. Kipimo: vidonge 2 asubuhi na jioni. Magnesium inasaidia kupunguza wasiwasi na kuboresha usingizi.",
        herbMeds: "Chai ya peremende na nanasi",
        herbMedsDetails: "Tumia majani ya peremende (mint) na vipande vya nanasi. Chemsha kwa dakika 5, kunywa baada ya chakula. Husaidia kutuliza tumbo na kupunguza kichefuchefu.",
        food: "üçç Nanasi, wali, samaki wa maji baridi",
        foodDetails: "Nanasi lina bromelain inayosaidia mmeng'enyo. Wali una nyuzinyuzi na ni rahisi kusaga. Samaki (tilapia, kambale) ana protini nyepesi. Epuka vyakula vya viungo, kahawa, na pombe.",
        additionalTips: [
            "Kula sehemu ndogo mara 5-6 kwa siku badala ya chakula kikubwa.",
            "Epuka kusema uongo au kufanya shughuli nyingi mara baada ya chakula.",
            "Tumia mbinu za kupumua kwa kina ili kupunguza wasiwasi.",
            "Kunywa maji ya joto na ndimu asubuhi kusaidia utumbo.",
            "Pata usingizi wa kutosha ‚Äì usingizi mdogo huongeza wasiwasi."
        ],
        precautions: [
            "Chen Pi inaweza kukausha kinywa ‚Äì kunywa maji ya kutosha.",
            "Gastro Comfort isitumike ikiwa una mzio wa mint.",
            "Nanasi linaweza kuwasha ulimi ‚Äì suuza kwa maji baada ya kula."
        ]
    },
    "Farasi": {
        diseases: [
            "Maumivu ya misuli",
            "Uchovu wa kudumu",
            "Homa za msimu",
            "Kuvimba miguu",
            "Sukari",
            "Maumivu ya mgongo",
            "Kukosa hamu ya kula",
            "Ngozi kukauka"
        ],
        chinaMeds: "Du Huo + Fang Feng (kwa misuli)",
        chinaMedsDetails: "Du Huo hupunguza maumivu ya misuli na viungo; Fang Feng hupunguza homa na misuli kufa ganzi. Kuchukwa vidonge 3 kwa siku (asubuhi, mchana, jioni) kwa wiki 2-3. Inasaidia kupunguza uchovu na kuvimba.",
        williamMeds: "Muscle Relax + Multivitamin",
        williamMedsDetails: "Muscle Relax ina magnesium na valerian kupumzisha misuli. Multivitamin ina B-complex na vitamini D kwa nishati. Kipimo: vidonge 2 asubuhi na 2 jioni. Inasaidia kupunguza maumivu na uchovu.",
        herbMeds: "Maji ya mwarobaini na chai ya mlonge",
        herbMedsDetails: "Chemsha majani ya mwarobaini na mlonge (neem) pamoja. Kunywa kikombe 1 asubuhi na jioni. Husaidia kupunguza maumivu ya misuli na kusafisha damu.",
        food: "üåæ Uji wa mtama, karanga, samaki",
        foodDetails: "Mtama una nishati na nyuzinyuzi. Karanga (karanga za nyasa) zina protini na mafuta bora. Samaki (mkisi, kaa) ana protini na omega-3. Epuka vyakula vya sukari nyingi na unga mweupe.",
        additionalTips: [
            "Fanya mazoezi ya kunyoosha misuli (stretching) kila siku.",
            "Pata massage ya misuli kwa mafuta ya mwarobaini au mafuta ya nazi.",
            "Tembea kwenye maji baridi (bwawa, bahari) kupunguza uvimbe wa miguu.",
            "Epuka kukaa kwenye baridi kwa muda mrefu.",
            "Kula ndizi na parachichi kwa potasiamu na magnesiamu."
        ],
        precautions: [
            "Du Huo inaweza kusababisha usingizi ‚Äì epuka kuendesha gari.",
            "Muscle Relax isitumike kwa zaidi ya wiki 2 bila ushauri wa daktari.",
            "Mlonge inaweza kuwa sumu kwa kiasi kikubwa ‚Äì shika kipimo."
        ]
    },
    "Mbuzi": {
        diseases: [
            "Ngozi kavu",
            "Wasiwasi",
            "Upungufu wa damu",
            "Kupoteza hamu ya kula",
            "Mzio",
            "Kuvimba kwa ngozi",
            "Maumivu ya kichwa",
            "Kukosa usingizi"
        ],
        chinaMeds: "Dang Gui + Bai Shao (kwa damu)",
        chinaMedsDetails: "Dang Gui (dong quai) hulisha damu na kurekebisha mzunguko; Bai Shao huimarisha damu na kutuliza. Kuchukwa vidonge 2 asubuhi na jioni kwa wiki 3-4. Inasaidia kupunguza upungufu wa damu na wasiwasi.",
        williamMeds: "Skin Repair Cream + Iron Plus",
        williamMedsDetails: "Skin Repair Cream yenye aloe vera, shea butter, na calendula ‚Äì paka kwenye ngozi kavu mara 2 kwa siku. Iron Plus ina chuma, vitamini C na B12 ‚Äì vidonge 1 kwa siku. Inasaidia ngozi na damu.",
        herbMeds: "Chai ya kunde na aloe vera",
        herbMedsDetails: "Tumia majani ya kunde (cassia) na gel ya aloe vera. Chemsha kwa dakika 5, kunywa kikombe 1 asubuhi. Husaidia kusafisha damu na kulainisha ngozi.",
        food: "ü•£ Uji wa soya, asali, mboga za majani",
        foodDetails: "Uji wa soya una protini na isoflavones kwa afya ya ngozi. Asali ya mwitu ina antioxidants. Mboga za majani (spinachi, kabichi) zina chuma na vitamini. Epuka vyakula vya kukaanga na sukari.",
        additionalTips: [
            "Weka mafuta ya nazi au shea butter kwenye ngozi kila baada ya kuoga.",
            "Kunywa maji ya kutosha (lita 2) ili kuweka ngozi unyevu.",
            "Pumzika na tafuta shughuli za kutuliza kama kusoma au kusikiliza muziki.",
            "Kula vyakula vyenye chuma kama nyama konda, dengu, na mboga za kijani.",
            "Epuka kukaa kwenye jua kali bila kinga."
        ],
        precautions: [
            "Dang Gui isitumike wakati wa hedhi nzito au ujauzito.",
            "Iron Plus inaweza kusababisha kuvimbiwa ‚Äì kunywa maji mengi.",
            "Aloe vera kwa mdomo inaweza kusababisha kuhara kwa baadhi."
        ]
    },
    "Kima": {
        diseases: [
            "Kukosa usingizi",
            "Maumivu ya kichwa",
            "Kuhara",
            "Mkazo",
            "Kukosa makini",
            "Wasiwasi mwingi",
            "Maumivu ya tumbo",
            "Kizunguzungu"
        ],
        chinaMeds: "Suan Zao Ren (kwa usingizi) + Yuan Zhi",
        chinaMedsDetails: "Suan Zao Ren (mbegu za jujube) hutuliza akili na kuboresha usingizi; Yuan Zhi hupunguza wasiwasi na kusafisha makohozi. Kuchukwa vidonge 2 jioni tu (kwa usingizi) na asubuhi kwa Yuan Zhi. Inasaidia kupunguza kukosa usingizi na mkazo.",
        williamMeds: "Focus Formula + Melatonin",
        williamMedsDetails: "Focus Formula ina ginkgo biloba, bacopa, na phosphatidylserine kwa kumbukumbu na makini. Melatonin (1-3mg) husaidia usingizi. Kipimo: Focus asubuhi, Melatonin saa 1 kabla ya kulala.",
        herbMeds: "Chai ya chamomile na ndimu",
        herbMedsDetails: "Tumia maua ya chamomile na maji ya ndimu. Chemsha kwa dakika 5, kunywa jioni. Husaidia kutuliza akili na kupunguza maumivu ya kichwa.",
        food: "üçå Ndizi, karanga, mtama",
        foodDetails: "Ndizi zina tryptophan na potasiamu kwa usingizi. Karanga (karanga za nyasa, korosho) zina magnesiamu. Mtama una wanga tata unaodumisha nishati. Epuka kahawa, chai kali, na sukari jioni.",
        additionalTips: [
            "Weka ratiba ya usingizi: lala na amka kwa wakati mmoja kila siku.",
            "Epuka skrini (simu, TV) saa 1 kabla ya kulala.",
            "Fanya mazoezi ya kupumua au kutafakari kabla ya kulala.",
            "Kula chakula chepesi jioni ‚Äì epuka vyakula vizito.",
            "Andika mawazo yako kabla ya kulala ili kuyatoa akilini."
        ],
        precautions: [
            "Suan Zao Ren inaweza kusababisha usingizi mchana ‚Äì usiendeshe gari baada ya kuitumia.",
            "Melatonin isitumike kwa muda mrefu bila ushauri wa daktari.",
            "Chamomile inaweza kusababisha mzio kwa wenye mzio wa maua."
        ]
    },
    "Jogoo": {
        diseases: [
            "Mzio wa ngozi",
            "Kikohozi",
            "Sinus",
            "Maumivu ya koo",
            "Shinikizo",
            "Homa za msimu",
            "Kuvimba kwa sinuses",
            "Maambukizi ya mafua"
        ],
        chinaMeds: "Gan Mao Ling + Chuan Xin Lian",
        chinaMedsDetails: "Gan Mao Ling hutibu mafua na homa; Chuan Xin Lian hupunguza maambukizi ya virusi na bakteria. Kuchukwa pakiti 1 kila baada ya masaa 6 kwa siku 3-5. Inasaidia kupunguza kikohozi na sinus.",
        williamMeds: "Sinus Clear + Cough Syrup",
        williamMedsDetails: "Sinus Clear ina eucalyptus, menthol, na goldenseal kupunguza msongamano wa pua. Cough Syrup yenye honey na ivy leaf hutuliza kikohozi. Kipimo: Sinus Clear vidonge 2 asubuhi na jioni; Cough Syrup kijiko 1 kila baada ya masaa 4.",
        herbMeds: "Asali na tangawizi, maji ya ci",
        herbMedsDetails: "Changanya kijiko 1 cha asali, kijiko 1 cha tangawizi iliyokunwa, na maji ya ci (lime). Kunywa asubuhi na jioni. Husaidia kutuliza koo na kupunguza kikohozi.",
        food: "ü•ö Mayai ya kienyeji, mboga za majani",
        foodDetails: "Mayai ya kienyeji yana protini na vitamini D. Mboga za majani (sukumawiki, spinach) zina antioxidants. Epuka vyakula vya kukaanga, maziwa, na sukari wakati wa sinus.",
        additionalTips: [
            "Pumua mvuke ya maji ya moto yenye mchaichai au eucalyptus kufungua pua.",
            "Weka unyevu hewani ili kupunguza kikohozi.",
            "Osha pua kwa maji ya chumvi (saline) mara 2 kwa siku.",
            "Epuka moshi wa sigara na vumbi.",
            "Kunywa maji mengi (supu, maji ya joto) kuyeyusha makohozi."
        ],
        precautions: [
            "Gan Mao Ling isitumike kwa zaidi ya siku 5 bila daktari.",
            "Chuan Xin Lian inaweza kusababisha kichefuchefu ‚Äì chukua baada ya chakula.",
            "Cough Syrup yenye asali isitumike kwa watoto chini ya mwaka 1."
        ]
    },
    "Mbwa": {
        diseases: [
            "Wasiwasi",
            "Moyo kutapatapa",
            "Kukosa usingizi",
            "Msongo",
            "Maumivu ya tumbo",
            "Kuhara",
            "Kupoteza hamu ya kula",
            "Kukosa utulivu"
        ],
        chinaMeds: "Bai Zi Ren + Ye Jiao Teng (kwa utulivu)",
        chinaMedsDetails: "Bai Zi Ren (mbegu za cypress) hutuliza moyo na kuboresha usingizi; Ye Jiao Teng hutuliza mishipa na kupunguza wasiwasi. Kuchukwa vidonge 2 asubuhi na jioni. Inasaidia kupunguza mapigo ya moyo na wasiwasi.",
        williamMeds: "Anxiety Aid + Probiotic",
        williamMedsDetails: "Anxiety Aid ina ashwagandha, passion flower, na L-theanine kwa utulivu. Probiotic ina bakteria nzuri kwa utumbo (gut-brain axis). Kipimo: Anxiety Aid vidonge 2 asubuhi na jioni; Probiotic kidonge 1 kwa siku.",
        herbMeds: "Chai ya lavender na maziwa ya joto",
        herbMedsDetails: "Tumia maua ya lavender na maziwa ya joto (au maziwa ya mboga). Kunywa jioni kabla ya kulala. Husaidia kutuliza mishipa na kupunguza wasiwasi.",
        food: "ü•ó Saladi, samaki, parachichi",
        foodDetails: "Saladi ya mboga mboga (lettuce, nyanya, tango) ina vitamini. Samaki (jodari, kambale) ana omega-3 kwa ubongo. Parachichi lina mafuta bora. Epuka kahawa, chai kali, na vyakula vya sukari.",
        additionalTips: [
            "Tafuta shughuli za kupumzika kama kusoma, kusikiliza muziki wa utulivu.",
            "Fanya mazoezi ya kupumua kwa kina (pumua ndefu, toa polepole).",
            "Tembea kwenye mazingira ya utulivu (bustani, ufukwe).",
            "Pata massage ya mwili kwa mafuta ya lavender.",
            "Epuka habari za msongo na mazungumzo ya wasiwasi kabla ya kulala."
        ],
        precautions: [
            "Bai Zi Ren inaweza kusababisha usingizi ‚Äì usiendeshe gari baada ya kuitumia.",
            "Anxiety Aid isitumike pamoja na dawa za kutuliza nyingine bila daktari.",
            "Lavender inaweza kusababisha mzio kwa wenye ngozi nyeti ‚Äì jaribu kwenye sehemu ndogo."
        ]
    },
    "Nguruwe": {
        diseases: [
            "Kuvimba mwili",
            "Kuhara",
            "Chunusi",
            "Mafua",
            "Uchovu",
            "Maumivu ya tumbo",
            "Ngozi yenye mafuta",
            "Kukosa hamu ya kula"
        ],
        chinaMeds: "Yi Yi Ren + Fu Ling (kwa maji mwilini)",
        chinaMedsDetails: "Yi Yi Ren (coix seed) hupunguza uvimbe na kusafisha ngozi; Fu Ling huondoa maji ya ziada na kutuliza tumbo. Kuchukwa vidonge 3 kwa siku (asubuhi, mchana, jioni) kwa wiki 3. Inasaidia kupunguza kuvimba na chunusi.",
        williamMeds: "Digestive Cleanse + Energy Plus",
        williamMedsDetails: "Digestive Cleanse ina mimea kama psyllium, fennel, na papaya kusafisha utumbo. Energy Plus ina B-complex na ginseng kwa nishati. Kipimo: Digestive Cleanse vidonge 2 asubuhi na jioni; Energy Plus kidonge 1 asubuhi.",
        herbMeds: "Maji ya dafu, chai ya mdalasini",
        herbMedsDetails: "Maji ya dafu (coconut water) yana electrolytes na husaidia kusafisha mwili. Chai ya mdalasini (cinnamon) ina antioxidants na hupunguza sukari. Kunywa kikombe 1 cha kila mmoja kwa siku.",
        food: "üç† Viazi vitamin, samaki, mboga",
        foodDetails: "Viazi vitamin vina vitamini A na nyuzinyuzi. Samaki (tilapia, kaa) ana protini nyepesi. Mboga za majani (spinachi, broccoli) zina antioxidants. Epuka vyakula vya mafuta mengi, sukari, na unga.",
        additionalTips: [
            "Kunywa maji ya kutosha (lita 2-3) kusaidia kuondoa maji ya ziada.",
            "Fanya mazoezi ya kutokwa jasho (kukimbia, kuogelea) kusafisha ngozi.",
            "Epuka vyakula vya kusindika na vya mafuta (chips, pizza).",
            "Osha uso kwa maji baridi na sabuni laini mara 2 kwa siku.",
            "Pata usingizi wa kutosha (masaa 7-8) ili kupunguza msongo na chunusi."
        ],
        precautions: [
            "Yi Yi Ren inaweza kusababisha kuhara kwa wengine ‚Äì punguza kipimo.",
            "Digestive Cleanse isitumike kwa zaidi ya wiki 2 mfululizo.",
            "Mdalasini inaweza kupunguza sukari kupita kiasi ‚Äì fuatilia sukari yako."
        ]
    }
};

        const animals = ["Panya", "Ng'ombe", "Simba", "Sungura", "Joka", "Nyoka", "Farasi", "Mbuzi", "Kima", "Jogoo", "Mbwa", "Nguruwe"];

        // ---------- Vipengele vya HTML ----------
        const registrationSection = document.getElementById('registrationSection');
        const profileSection = document.getElementById('profileSection');
        const cameraSection = document.getElementById('cameraSection');
        const resultsSection = document.getElementById('resultsSection');
        const adminPanel = document.getElementById('adminPanel');
        const adminToggleBtn = document.getElementById('adminToggleBtn');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const adminCode = document.getElementById('adminCode');
        const adminStatus = document.getElementById('adminStatus');
        const adminBadge = document.getElementById('adminBadge');
        const scanLimitMsg = document.getElementById('scanLimitMsg');

        const deviceIdSpan = document.getElementById('deviceId');
        const regName = document.getElementById('regName');
        const regYear = document.getElementById('regYear');
        const registerBtn = document.getElementById('registerBtn');
        const profileName = document.getElementById('profileName');
        const profileYear = document.getElementById('profileYear');
        const startScanBtn = document.getElementById('startScanBtn');
        const resetBtn = document.getElementById('resetBtn');
        const cancelCameraBtn = document.getElementById('cancelCameraBtn');
        const captureBtn = document.getElementById('captureBtn');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const laserLine = document.getElementById('laserLine');
        const scanStatus = document.getElementById('scanStatus');
        const newScanBtn = document.getElementById('newScanBtn');
        const homeBtn = document.getElementById('homeBtn');
        const downloadReportBtn = document.getElementById('downloadReportBtn');

        // Matokeo elements
        const resultZodiac = document.getElementById('resultZodiac');
        const diseaseList = document.getElementById('diseaseList');
        const chinaMeds = document.getElementById('chinaMeds');
        const williamMeds = document.getElementById('williamMeds');
        const herbMeds = document.getElementById('herbMeds');
        const foodTip = document.getElementById('foodTip');

        // ---------- State ----------
        let mediaStream = null;
        let currentYear = null;
        let currentName = null;

        // Device ID bandia
        deviceIdSpan.innerText = 'üî¨ DEVICE: ZDS-' + Math.random().toString(36).substring(2, 10).toUpperCase();

        // ---------- Admin mode ----------
        const ADMIN_CODE = "admin2025"; // Badilisha na code yako mwenyewe
        let isAdmin = localStorage.getItem('isAdmin') === 'true';

        // Toggle admin panel
        adminToggleBtn.addEventListener('click', () => {
            adminPanel.classList.toggle('hidden');
        });

        adminLoginBtn.addEventListener('click', () => {
            const code = adminCode.value.trim();
            if (code === ADMIN_CODE) {
                isAdmin = true;
                localStorage.setItem('isAdmin', 'true');
                adminStatus.innerText = '‚úî Umeingia kama Admin. Sasa unaweza scan nyingi.';
                adminCode.value = '';
                adminPanel.classList.add('hidden');
                // Update UI
                updateProfileView();
            } else {
                adminStatus.innerText = '‚ùå Code sio sahihi.';
            }
        });

        adminLogoutBtn.addEventListener('click', () => {
            isAdmin = false;
            localStorage.removeItem('isAdmin');
            adminStatus.innerText = '‚úñ Umetoka kwenye admin mode.';
            adminCode.value = '';
            adminPanel.classList.add('hidden');
            updateProfileView();
        });

        // ---------- Angalia kama user ameshapiga scan ----------
        function hasUserScanned() {
            return localStorage.getItem('hasScanned') === 'true';
        }

        function setUserScanned( scanned ) {
            localStorage.setItem('hasScanned', scanned ? 'true' : 'false');
        }

        // ---------- Hifadhi na load matokeo yaliyopo ----------
        function saveReportToStorage(zodiac, diseasesArr, china, william, herb, food) {
            const report = {
                zodiac,
                diseases: diseasesArr,
                chinaMeds: china,
                williamMeds: william,
                herbMeds: herb,
                foodTip: food,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('lastReport', JSON.stringify(report));
        }

        function loadLastReport() {
            const saved = localStorage.getItem('lastReport');
            return saved ? JSON.parse(saved) : null;
        }

        function displaySavedReport() {
            const report = loadLastReport();
            if (report) {
                resultZodiac.innerText = report.zodiac;
                diseaseList.innerHTML = '';
                report.diseases.forEach(d => {
                    const li = document.createElement('li');
                    li.textContent = d;
                    diseaseList.appendChild(li);
                });
                chinaMeds.innerText = report.chinaMeds;
                williamMeds.innerText = report.williamMeds;
                herbMeds.innerText = report.herbMeds;
                foodTip.innerText = 'üçΩÔ∏è ' + report.foodTip;

                // Onyesha section ya matokeo, ficha nyingine
                registrationSection.classList.add('hidden');
                profileSection.classList.add('hidden');
                cameraSection.classList.add('hidden');
                resultsSection.classList.remove('hidden');
            }
        }

        // ---------- Angalia kama mtumiaji anaweza kuscan ----------
        function canScan() {
            // Admin anaweza siku zote
            if (isAdmin) return true;
            // User wa kawaida anaweza kama hajawahi scan
            return !hasUserScanned();
        }

        // Update profile section (onyesha au ficha kitufe cha scan)
        function updateProfileView() {
            if (!profileSection.classList.contains('hidden')) {
                const can = canScan();
                startScanBtn.style.display = can ? 'block' : 'none';
                scanLimitMsg.style.display = can ? 'none' : 'block';
                // Onyesha admin badge kama ni admin
                if (isAdmin) {
                    adminBadge.classList.remove('hidden');
                } else {
                    adminBadge.classList.add('hidden');
                }
            }
        }

        // ---------- Load user ----------
        function loadUserFromStorage() {
            const savedName = localStorage.getItem('zodiacName');
            const savedYear = localStorage.getItem('zodiacYear');
            if (savedName && savedYear) {
                currentName = savedName;
                currentYear = parseInt(savedYear);
                profileName.innerText = savedName;
                profileYear.innerText = 'üîí Imefungwa ¬∑ Mwaka: ' + savedYear;
                registrationSection.classList.add('hidden');
                profileSection.classList.remove('hidden');
                cameraSection.classList.add('hidden');
                resultsSection.classList.add('hidden');

                // Angalia kama kuna report iliyohifadhiwa
                const lastReport = loadLastReport();
                if (lastReport) {
                    displaySavedReport();
                } else {
                    updateProfileView();
                }
            } else {
                registrationSection.classList.remove('hidden');
                profileSection.classList.add('hidden');
                cameraSection.classList.add('hidden');
                resultsSection.classList.add('hidden');
            }
        }

        // ---------- Usajili ----------
        registerBtn.addEventListener('click', () => {
            const name = regName.value.trim();
            const year = regYear.value.trim();
            if (!name || !year) {
                alert('Tafadhali jaza jina na mwaka wako.');
                return;
            }
            const yearNum = parseInt(year);
            if (yearNum < 1900 || yearNum > 2100) {
                alert('Tafadhali ingiza mwaka sahihi (1900 - 2100).');
                return;
            }
            localStorage.setItem('zodiacName', name);
            localStorage.setItem('zodiacYear', yearNum);
            // Reset scan flag kwa user mpya
            setUserScanned(false);
            loadUserFromStorage();
        });

        // ---------- Reset (badilisha mtumiaji) ----------
        resetBtn.addEventListener('click', () => {
            localStorage.removeItem('zodiacName');
            localStorage.removeItem('zodiacYear');
            localStorage.removeItem('lastReport');
            setUserScanned(false);
            stopCamera();
            loadUserFromStorage();
        });

        // ---------- Fungua Kamera ----------
        startScanBtn.addEventListener('click', () => {
            if (!canScan()) {
                alert('Umepiga scan mara moja tayari. Kama unahitaji nyingine, ingia kama admin.');
                return;
            }
            openCamera();
        });

        cancelCameraBtn.addEventListener('click', () => {
            stopCamera();
            profileSection.classList.remove('hidden');
            cameraSection.classList.add('hidden');
        });

        async function openCamera() {
            profileSection.classList.add('hidden');
            cameraSection.classList.remove('hidden');
            scanStatus.innerText = '‚è≥ Inaandaa kamera...';

            try {
                stopCamera();
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } },
                    audio: false
                });
                video.srcObject = mediaStream;
                video.style.display = 'block';
                canvas.style.display = 'none';
                laserLine.style.display = 'none';
                scanStatus.innerText = 'üì∏ Kamera iko tayari. Bonyeza "PIGA SELFI"';
            } catch (err) {
                console.error(err);
                scanStatus.innerText = '‚ùå Kamera haifunguki. Hakikisha umeruhusu kamera na unatumia localhost/https.';
                alert('Hitilafu ya kamera: ' + (err.message || 'Jaribu kutumia simu nyingine au browser tofauti.'));
            }
        }

        function stopCamera() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            video.srcObject = null;
        }

        // ---------- Piga Selfie na Scan ----------
        captureBtn.addEventListener('click', () => {
            if (!video.videoWidth) {
                alert('Kamera bado haijaanza. Subiri kidogo.');
                return;
            }

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            
            video.style.display = 'none';
            canvas.style.display = 'block';
            
            laserLine.style.display = 'block';
            captureBtn.style.display = 'none';
            scanStatus.innerText = 'üîç INACHAMBUUA... (scan inaendelea)';

            setTimeout(() => {
                if (cameraSection.classList.contains('hidden')) return;
                laserLine.style.display = 'none';
                scanStatus.innerText = '‚úÖ Uchambuzi umekamilika!';
                
                const year = parseInt(localStorage.getItem('zodiacYear'));
                const index = (year - 4) % 12;
                const zodiac = animals[index >= 0 ? index : index + 12];
                const data = zodiacData[zodiac] || zodiacData["Nyoka"];

                // Hifadhi matokeo kwenye localStorage
                saveReportToStorage(zodiac, data.diseases, data.chinaMeds, data.williamMeds, data.herbMeds, data.food);

                // Weka flag ya scanned (kama si admin)
                if (!isAdmin) {
                    setUserScanned(true);
                }

                // Onyesha matokeo
                resultZodiac.innerText = zodiac;
                diseaseList.innerHTML = '';
                data.diseases.forEach(d => {
                    const li = document.createElement('li');
                    li.textContent = d;
                    diseaseList.appendChild(li);
                });
                chinaMeds.innerText = data.chinaMeds;
                williamMeds.innerText = data.williamMeds;
                herbMeds.innerText = data.herbMeds;
                foodTip.innerText = 'üçΩÔ∏è ' + data.food;

                stopCamera();
                cameraSection.classList.add('hidden');
                resultsSection.classList.remove('hidden');
            }, 4000);
        });

        // ---------- Download Report ----------
        downloadReportBtn.addEventListener('click', () => {
            const zodiac = resultZodiac.innerText;
            const diseases = Array.from(diseaseList.children).map(li => li.textContent).join(', ');
            const china = chinaMeds.innerText;
            const william = williamMeds.innerText;
            const herb = herbMeds.innerText;
            const food = foodTip.innerText;
            const name = localStorage.getItem('zodiacName') || '';
            const year = localStorage.getItem('zodiacYear') || '';

            const content = `
RIPOTI YA ZODIAC HEALTH SCANNER
================================
Zodiac: ${zodiac}
Jina: ${name}
Mwaka: ${year}
Tarehe: ${new Date().toLocaleString()}

üö® MAGONJWA YANAYOWEZA KUKUFIKIA:
${diseases}

üåø DAWA ZA KICHINA:
${china}

üíä DR. WILLIAM CLINIC:
${william}

üå± TIBA YA NYUMBANI:
${herb}

${food}

-- Matokeo yamepakuliwa kutoka Zodiac Bio-Scanner --
            `;

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Zodiac_Report_${zodiac}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // ---------- New scan (kutoka results) ----------
        newScanBtn.addEventListener('click', () => {
            if (!canScan()) {
                alert('Huwezi kufanya scan nyingine. Ingia kama admin.');
                return;
            }
            resultsSection.classList.add('hidden');
            openCamera();
        });

        homeBtn.addEventListener('click', () => {
            stopCamera();
            resultsSection.classList.add('hidden');
            profileSection.classList.remove('hidden');
            updateProfileView();
        });

        // ---------- Initialize ----------
        loadUserFromStorage();
        updateProfileView();

        window.addEventListener('beforeunload', () => {
            stopCamera();
        });
    })();
</script>
</body>
</html>
